# 要件定義書

## はじめに

Intelligent HPA (IHPA) は、Kubernetesクラスタにおいて、メトリクスの予測に基づいてワークロードを事前にスケーリングするカスタムコントローラーです。従来のHorizontal Pod Autoscaler (HPA) は現在のメトリクス値に基づいてリアクティブにスケーリングを行いますが、IHPAは機械学習による時系列予測を活用してプロアクティブなスケーリングを実現します。

## 用語集

- **IHPA**: IntelligentHorizontalPodAutoscaler - 予測ベースのオートスケーリングを行うカスタムリソース
- **FittingJob**: 機械学習モデルの訓練と予測を実行するジョブリソース
- **Estimator**: 予測データを受け取り、メトリクスプロバイダに送信するリソース
- **MetricProvider**: メトリクスの取得・送信を行うプロバイダ（Datadog、Prometheusなど）
- **Prophet**: Facebookが開発した時系列予測ライブラリ
- **SST**: Singular Spectrum Transformation - 変化点検知に使用される手法
- **ConfigMap**: Kubernetesの設定データを格納するリソース
- **CronJob**: 定期実行されるKubernetesジョブ

## 要件

### 要件 1: IHPA リソース管理

**ユーザーストーリー:** Kubernetes管理者として、IHPAリソースを作成・管理したい。そうすることで、ワークロードの予測ベースオートスケーリングを設定できる。

#### 受け入れ基準

1. IHPAリソースが作成されたとき、システムは対応するHPA、FittingJob、Estimatorリソースを生成しなければならない
2. IHPAリソースが更新されたとき、システムは関連するすべてのリソースを適切に更新しなければならない
3. IHPAリソースが削除されたとき、システムは関連するすべてのリソースをクリーンアップしなければならない
4. システムはIHPAとその子リソース間の関係を追跡するためのアノテーションを維持しなければならない
5. システムはIHPAリソースごとに複数のメトリクスをサポートしなければならない

### 要件 2: メトリクス予測機能

**ユーザーストーリー:** システム運用者として、システムに将来のメトリクスを予測してほしい。そうすることで、負荷が増加する前にアプリケーションをプロアクティブにスケールできる。

#### 受け入れ基準

1. 十分な履歴データが利用可能なとき、FittingJobは時系列予測のためのProphetモデルを訓練しなければならない
2. 訓練が完了したとき、FittingJobは次の週の予測メトリクスを生成しなければならない
3. FittingJobは予測結果をtimestamp、yhat、yhat_upper、yhat_lowerカラムを持つCSV形式で保存しなければならない
4. 予測データが利用可能なとき、Estimatorは適切なタイミングで予測メトリクスをMetricProviderに送信しなければならない
5. システムは予測のためにResourceとExternalの両方のメトリクスタイプをサポートしなければならない

### 要件 3: 変化点検知機能

**ユーザーストーリー:** データサイエンティストとして、システムにメトリクスの変化点を検知してほしい。そうすることで、異なる行動パターンを持つ期間を除外して訓練データの品質を向上できる。

#### 受け入れ基準

1. 変化点検知が有効なとき、FittingJobは異常な期間を特定するためにSSTアルゴリズムを適用しなければならない
2. FittingJobは設定された閾値に基づいて検出された変化点を訓練データから除外しなければならない
3. 変化点検知後に十分なデータが残らないとき、FittingJobは元のデータを使用しなければならない
4. システムは変化点検知アルゴリズムの設定可能なパラメータをサポートしなければならない
5. FittingJobは変化点検知の前後のデータ量をログに記録しなければならない

### 要件 4: メトリクス調整機能

**ユーザーストーリー:** システム管理者として、最近の精度に基づいてシステムが予測を調整してほしい。そうすることで、予測がずれても効果的なスケーリング判断を維持できる。

#### 受け入れ基準

1. 調整モードが有効なとき、Estimatorは最近の予測と実際の値を比較しなければならない
2. Estimatorは予測精度に基づいて調整比率を計算しなければならない
3. 新しい予測を送信するとき、Estimatorはyhat_upper境界内で計算された調整を適用しなければならない
4. Estimatorはメトリクス調整のために「raw」と「adjust」の両方のモードをサポートしなければならない
5. システムはプロアクティブスケーリング動作を維持するために予測を上方向にのみ調整しなければならない

### 要件 5: メトリクスプロバイダ統合

**ユーザーストーリー:** DevOpsエンジニアとして、既存の監視システムと統合したい。そうすることで、現在の可観測性スタックでIHPAを使用できる。

#### 受け入れ基準

1. システムはメトリクスの取得と送信のためのメトリクスプロバイダとしてDatadogをサポートしなければならない
2. Datadogを使用するとき、システムはAPIキーとAPPキー認証を処理しなければならない
3. システムは適切な集約（訓練データ用のsum）で履歴メトリクスを取得しなければならない
4. システムは適切な命名規則（ake.ihpa.forecasted_プレフィックス）で予測メトリクスを送信しなければならない
5. システムは将来の実装のためにPrometheusプロバイダインターフェースをサポートしなければならない

### 要件 6: スケジューリングと実行

**ユーザーストーリー:** プラットフォームエンジニアとして、予測ジョブが自動的に実行されてほしい。そうすることで、手動介入なしに予測を最新に保てる。

#### 受け入れ基準

1. FittingJobはスケジュール実行のためのCronJobリソースを作成しなければならない
2. executeOn時刻が指定されたとき、CronJobはランダム化された分でその時刻に実行されなければならない
3. FittingJobはkubectl create jobコマンドによる手動実行をサポートしなければならない
4. 十分な履歴データが存在しないとき、FittingJobは予測をスキップし理由をログに記録しなければならない
5. システムは設定可能な季節性検知（auto、daily、weekly、yearly）をサポートしなければならない

### 要件 7: RBACとセキュリティ

**ユーザーストーリー:** セキュリティ管理者として、適切なアクセス制御がほしい。そうすることで、IHPAコンポーネントが必要最小限の権限を持てる。

#### 受け入れ基準

1. システムはFittingJob実行のためのServiceAccount、Role、RoleBindingリソースを作成しなければならない
2. FittingJobはその名前空間でConfigMapを読み書きする権限を持たなければならない
3. EstimatorはConfigMapを読み取りMetricProvider APIにアクセスする権限を持たなければならない
4. システムはプライベートコンテナレジストリのためのimagePullSecretsをサポートしなければならない
5. システムは名前空間とIHPAインスタンスごとに権限を分離しなければならない

### 要件 8: 設定とカスタマイズ

**ユーザーストーリー:** 機械学習エンジニアとして、予測パラメータをカスタマイズしたい。そうすることで、特定のワークロードパターンに対してシステムを最適化できる。

#### 受け入れ基準

1. システムは予測タイミングのための設定可能なギャップ分をサポートしなければならない
2. FittingJobは特殊な予測アルゴリズムのためのカスタムコンテナイメージを受け入れなければならない
3. システムはFittingJobコンテナに渡されるカスタム設定文字列をサポートしなければならない
4. FittingJobは設定可能な変化点検知パラメータをサポートしなければならない
5. システムはすべてのオプション設定パラメータにデフォルト値を提供しなければならない

### 要件 9: 監視と可観測性

**ユーザーストーリー:** サイト信頼性エンジニアとして、IHPA操作を監視したい。そうすることで、問題をトラブルシュートしシステムの健全性を確認できる。

#### 受け入れ基準

1. システムは適切なログレベルですべての主要操作をログに記録しなければならない
2. FittingJobは訓練進捗、データ品質メトリクス、予測結果をログに記録しなければならない
3. Estimatorはメトリクス調整計算と送信操作をログに記録しなければならない
4. システムはHPA describeコマンドを通じて予測精度を公開しなければならない
5. システムはクラッシュすることなくエラーを適切に処理しログに記録しなければならない

### 要件 10: データ永続化と管理

**ユーザーストーリー:** データエンジニアとして、予測データが適切に保存・管理されてほしい。そうすることで、システムが確実に動作できる。

#### 受け入れ基準

1. FittingJobは予測結果をKubernetes ConfigMapに保存しなければならない
2. EstimatorはConfigMapの変更を監視し新しい予測データに反応しなければならない
3. システムは新しい予測を既存データとマージし、新しい予測を優先しなければならない
4. システムはConfigMapサイズ制限を適切に処理しなければならない
5. FittingJobは無制限の成長を防ぐために古い予測データをクリーンアップしなければならない